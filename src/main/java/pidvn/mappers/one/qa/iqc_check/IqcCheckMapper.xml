<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="pidvn.mappers.one.qa.iqc_check.IqcCheckMapper">

    <resultMap id="getIqcRequests-result"
               type="pidvn.modules.qa.iqc_check.models.IqcRequestVo">
        <result column="request_no" property="requestNo" javaType="String"/>
        <result column="status_name" property="statusName" javaType="String"/>
        <result column="requested_by" property="requestedBy" javaType="String"/>
        <result column="requested_by_name" property="requestedByName" javaType="String"/>
        <result column="created_at" property="createdAt" javaType="Date"/>
    </resultMap>
    <select id="getIqcRequests" resultMap="getIqcRequests-result">
        SELECT
            R.*, S.name AS status_name, U.name requested_by_name
        FROM
            iqc_request R
        LEFT JOIN
            iqc_request_status S ON R.status = S.id
        LEFT JOIN
            users U ON R.requested_by = U.username
        WHERE 1 = 1

        <if test="invoice != null and invoice != ''">
            AND R.invoice = #{invoice}
        </if>

        <if test="requestNo != null and requestNo != ''">
            AND R.request_no = #{requestNo}
        </if>

        <if test="status != null">
            AND R.status = #{status}
        </if>

        <if test="fromDate != null and toDate != null">
            and DATE_FORMAT(R.created_at, '%Y-%m-%d') between DATE_FORMAT(#{fromDate}, '%Y-%m-%d') and DATE_FORMAT(#{toDate}, '%Y-%m-%d')
        </if>
        order by R.created_at desc
    </select>


    <resultMap id="getIqcDataMaster-result"
               type="pidvn.modules.qa.iqc_check.models.IqcDataVo">
        <result column="request_no" property="requestNo" javaType="String"/>
        <result column="lot_group" property="lotGroup" javaType="String"/>
        <result column="checked_amount" property="checkedAmount" javaType="Integer"/>
        <result column="updated_at" property="updatedAt" javaType="Date"/>
        <result column="requested_at" property="requestedAt" javaType="Date"/>
        <result column="iqc_at" property="iqcAt" javaType="Date"/>
    </resultMap>
    <select id="getIqcDataMaster" resultMap="getIqcDataMaster-result">

        -- Master
        with
        T01 as (
            select
                 R.request_no, P.invoice, R.supplier,  P.model,
                 L.lot_group, sum(P.qty) as qty, count(P.id) as amount,
                 R.created_at as requested_at
            from pur_wh_records P
            left join lots L on P.lot_no = L.lot_no
            left join iqc_request R on L.invoice = R.invoice and R.request_no = #{requestNo}
            where 1 = 1
            and P.record_type = 'IM'
            and P.invoice = #{invoice}
            and P.slip_no = #{requestNo}
            and P.flag = '1'
            <if test="lotGroup != null">
                and L.lot_group = #{lotGroup}
            </if>
            <if test="model != null">
                and P.model = #{model}
        </if>
            group by P.model, L.lot_group
        ),
        T02 as (
            select
                T01.*, M.result1, M.result2, M.result3 , M.remark,
                M.created_by, M.updated_at as iqc_at, A.checked_amount
            from T01
            left join iqc_data_master M
                on T01.lot_group = M.lot_group and T01.model = M.model
                and M.request_no = #{requestNo} and M.invoice = #{invoice}
            left join (
                select
                    D.request_no, D.lot_group, count(*) checked_amount, L.model, D.invoice
                from iqc_data_detail D
                inner join lots L on D.lot_no = L.lot_no
                group by D.lot_group, L.model
            ) as A on T01.lot_group = A.lot_group and A.request_no = #{requestNo} and A.invoice = #{invoice} and T01.model = A.model
        )
        select T02.* from T02
        order by T02.model, T02.lot_group;

    </select>


    <resultMap id="getIqcDataDetail-result"
               type="pidvn.modules.qa.iqc_check.models.IqcDataVo">
        <result column="lot_group" property="lotGroup" javaType="String"/>
        <result column="lot_no" property="lotNo" javaType="String"/>
        <result column="updated_at" property="updatedAt" javaType="Date"/>
        <result column="created_by" property="createdBy" javaType="String"/>
        <result column="created_by_name" property="createdByName" javaType="String"/>
        <result column="request_no" property="requestNo" javaType="String"/>
        <result column="requested_at" property="requestedAt" javaType="Date"/>
        <result column="iqc_at" property="iqcAt" javaType="Date"/>
    </resultMap>
    <select id="getIqcDataDetail" resultMap="getIqcDataDetail-result">

        -- Detail
        with
        T01 as (
            select
                R.request_no, P.invoice, P.model, L.lot_group, L.lot_no, P.qty
            from pur_wh_records P
            left join lots L on P.lot_no = L.lot_no
            left join iqc_request R on L.invoice = R.invoice and R.request_no = #{requestNo}
            where 1 = 1
            and P.record_type = 'IM'
            and P.invoice = #{invoice}
            and P.flag = '1'
            <if test="lotGroup">
                and L.lot_group = #{lotGroup}
            </if>
            and P.model = #{model}
        ),
        T02 as (
            select
                T01.*, D.id, D.result1, D.result2, D.result3, D.remark, D.updated_at as iqc_at, D.created_by,
                (select U.name from users U where U.username = D.created_by) as created_by_name
            from T01
            left join iqc_data_detail D on T01.lot_no = D.lot_no and T01.request_no = D.request_no
        )
        select T02.* from T02
        order by T02.lot_no asc;


    </select>
</mapper>