<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="pidvn.mappers.one.spare_part.SparePartMapper">

    <resultMap id="getSparePartRecords-result"
               type="pidvn.modules.spare_part.models.SparePartRecordVo">
        <result column="request_no" property="requestNo" javaType="String"/>
        <result column="part_number" property="partNumber" javaType="String"/>
        <result column="galileo_name" property="galileoName" javaType="String"/>
        <result column="wh_user_code" property="whUserCode" javaType="String"/>
        <result column="receive_user_code" property="receiveUserCode" javaType="String"/>
        <result column="wh_user" property="whUser" javaType="String"/>
        <result column="other_user" property="otherUser" javaType="String"/>
        <result column="created_at" property="createdAt" javaType="Date"/>
        <result column="updated_at" property="updatedAt" javaType="Date"/>
        <result column="machine_id" property="machineId" javaType="Integer"/>
        <result column="factory_code" property="factoryCode" javaType="String"/>
        <result column="goods_type" property="goodsType" javaType="String"/>
    </resultMap>
    <select id="getSparePartRecords" resultMap="getSparePartRecords-result">
        select
            A.id, A.request_no, A.part_number, A.date, A.line, A.remark, A.goods_type, A.po, A.supplier,
            (select U.name from users U where U.username = A.wh_user_code) wh_user,
            (select U.name from users U where U.username = A.receive_user_code) other_user,
            A.machine machine_id, A.created_at, A.updated_at, A.wh_user_code, A.receive_user_code,
            (select B.vn_name from spare_part_machine_standard B where 1 = 1 and B.id = A.machine) machine,
            B.galileo_name, A.factory_code,
            CASE
                WHEN A.type = 'INPUT' then A.qty
                WHEN A.type = 'OUTPUT' then A.qty
                WHEN A.type = 'OK_RETURN' then A.qty*(-1)
                WHEN A.type = 'NG_RETURN' then A.qty*(-1)
            END as qty,
            CASE
                WHEN A.type = 'INPUT' then 'Nhập kho'
                WHEN A.type = 'OUTPUT' then 'Xuất kho'
                WHEN A.type = 'OK_RETURN' then 'Trả về (OK)'
                WHEN A.type = 'NG_RETURN' then 'Trả VỀ (NG)'
            END as type
        from spare_part_records A
        left join spare_parts B on (A.part_number = B.part_number and A.goods_type = B.type)
        where 1 = 1
        <if test="dateRange != null and dateRange.size != 0">
            and A.date between #{dateRange[0]} and #{dateRange[1]}
        </if>
        order by A.id desc

    </select>



    <resultMap id="getSparePartRecordsByStandardPrice-result"
               type="pidvn.modules.spare_part.models.SparePartRecordVo">
        <result column="request_no" property="requestNo" javaType="String"/>
        <result column="part_number" property="partNumber" javaType="String"/>
        <result column="galileo_name" property="galileoName" javaType="String"/>
        <result column="wh_user_code" property="whUserCode" javaType="String"/>
        <result column="receive_user_code" property="receiveUserCode" javaType="String"/>
        <result column="created_at" property="createdAt" javaType="Date"/>
        <result column="updated_at" property="updatedAt" javaType="Date"/>
        <result column="standard_price" property="standardPrice" javaType="Float"/>
        <result column="currency_code" property="currencyCode" javaType="String"/>
        <result column="total_price" property="totalPrice" javaType="Float"/>
        <result column="factory_code" property="factoryCode" javaType="String"/>

    </resultMap>
    <select id="getSparePartRecordsByStandardPrice" resultMap="getSparePartRecordsByStandardPrice-result">

        with
        T01 as (
        select
        A.part_number, B.galileo_name, A.date, A.qty, A.wh_user_code, A.receive_user_code, A.created_at,
        A.line, C.vn_name machine, A.remark,  A.factory_code, A.request_no,
        case
            when A.type = 'OUTPUT' then 'Xuất kho'
            when A.type = 'OK_RETURN' then 'Trả về kho'
        end as type
        from spare_part_records A
        left join spare_parts B on A.part_number = B.part_number
        left join spare_part_machine_standard C on A.machine = C.id
        where 1 = 1
        <if test="date != null">
            and DATE_FORMAT(A.date, '%Y-%m') = DATE_FORMAT(#{date}, '%Y-%m')
        </if>
        ),
        T02 as (
        SELECT
        A.pnsucsm galileo_name, A.cdfc factory_code, DATE_FORMAT(A.ymd8ent, '%Y-%m-%d') input_date,
        DATE_FORMAT(A.ymd8st, '%Y-%m-%d') effective_date,
        DATE_FORMAT(A.ymd8ed, '%Y-%m-%d') expiry_date, A.ucstdi standard_price, A.cdcur currency_code, A.umstduc unit
        FROM pidvn.tnmu007_standard_unit_cost A
        where 1 = 1
        order by A.ymd8ent desc
        )
        select
        T01.*, T02.factory_code, T02.standard_price, T02.currency_code, T02.unit, ROUND((T02.standard_price*T01.qty), 4)
        total_price
        from T01
        left join T02 on (T01.galileo_name = T02.galileo_name and (T01.date between T02.effective_date and
        T02.expiry_date and T01.factory_code = T02.factory_code))
        where 1 = 1
        order by T01.date desc

    </select>


    <resultMap id="getSparePartInventory-result"
               type="pidvn.modules.spare_part.models.SparePartRecordVo">
        <result column="part_number" property="partNumber" javaType="String"/>
        <result column="galileo_name" property="galileoName" javaType="String"/>
        <result column="created_at" property="createdAt" javaType="Date"/>
        <result column="standard_price" property="standardPrice" javaType="Float"/>
        <result column="currency_code" property="currencyCode" javaType="String"/>
        <result column="total_price" property="totalPrice" javaType="Float"/>
        <result column="factory_code" property="factoryCode" javaType="String"/>
    </resultMap>
    <select id="getSparePartInventory" resultMap="getSparePartInventory-result">
        <![CDATA[

            with
            T01 as (
                SELECT I.part_number, I.position, I.qty, S.galileo_name, DATE_FORMAT(I.created_at,'%Y-%m-%d') date, I.created_at FROM spare_part_inventory_data I
                left join spare_parts S on I.part_number = S.part_number
                where 1 = 1 and I.request_id = #{requestId}
            ),
            T02 as (
                SELECT
                    A.pnsucsm galileo_name, A.cdfc factory_code, DATE_FORMAT(A.ymd8ent, '%Y-%m-%d') input_date, DATE_FORMAT(A.ymd8st, '%Y-%m-%d') effective_date,
                    DATE_FORMAT(A.ymd8ed, '%Y-%m-%d') expiry_date, A.ucstdi standard_price, A.cdcur currency_code, A.umstduc unit
                FROM pidvn.tnmu007_standard_unit_cost A
                where 1 = 1 and A.cdfc = 'RE'
                order by A.ymd8ent desc
            )
            select
                T01.*, T02.factory_code, T02.standard_price, T02.currency_code, T02.unit, ROUND((T02.standard_price*T01.qty), 4) total_price
            from T01
            left join T02 on (T01.galileo_name = T02.galileo_name and (T01.date between T02.effective_date and T02.expiry_date))

        ]]>
    </select>


    <resultMap id="getSparePartDataChart-result"
               type="pidvn.modules.spare_part.models.SparePartDataChartVo">
        <result column="total_amount" property="totalAmount" javaType="Float"/>

    </resultMap>
    <select id="getSparePartDataChart" resultMap="getSparePartDataChart-result">
            with
            T01 as (
                select A.*, B.galileo_name from spare_part_data_chart A
                left join spare_parts B on A.part_number = B.part_number
                where 1 = 1
                <if test="date != null">
                    and DATE_FORMAT(A.date, '%Y-%m') = DATE_FORMAT(#{date}, '%Y-%m')
                </if>
            ),
            T02 as (
                select
                    A.pnsucsm galileo_name, A.cdfc factory_code, DATE_FORMAT(A.ymd8ent, '%Y-%m-%d') input_date,
                    DATE_FORMAT(A.ymd8st, '%Y-%m-%d') effective_date,
                    DATE_FORMAT(A.ymd8ed, '%Y-%m-%d') expiry_date, A.ucstdi standard_price, A.cdcur currency_code, A.umstduc unit
                from tnmu007_standard_unit_cost A
                where 1 = 1
                and A.cdfc = 'RE'
                order by A.ymd8ent desc
            ),
            T03 as (
                select
                    T01.part_number, T02.galileo_name, T01.qty, T01.date, T01.machine, T01.line, ROUND((T02.standard_price*T01.qty), 1) total_amount
                from T01
                left join T02 on (
                        T01.galileo_name = T02.galileo_name
                    and	(T01.date between T02.effective_date and T02.expiry_date)
                )
                where 1 = 1
            )

            <if test="chartType == 1">
                select T03.line, sum(T03.total_amount) total_amount from T03
                where 1 = 1
                and T03.total_amount > 0
                group by T03.line
                order by T03.line asc
            </if>
            <if test="chartType == 2">
                select T03.line, T03.machine, sum(T03.total_amount) total_amount from T03
                where 1 = 1
                and T03.total_amount > 0
                group by T03.line, T03.machine
                order by T03.line asc
            </if>
    </select>


    <resultMap id="getSparePartRequestMasters-result"
               type="pidvn.modules.spare_part.models.SparePartRequestVo">
        <result column="request_no" property="requestNo" javaType="String"/>
        <result column="created_by_name" property="createdByName" javaType="String"/>
        <result column="subsection_name" property="subsectionName" javaType="String"/>
        <result column="factory_code" property="factoryCode" javaType="String"/>
        <result column="factory_name" property="factoryName" javaType="String"/>
    </resultMap>
    <select id="getSparePartRequestMasters" resultMap="getSparePartRequestMasters-result">
        SELECT
            M.*, U.name created_by_name,S.name subsection_name,
            case
                when M.factory_code = 'RE' then 'RELAY FACTORY'
                when M.factory_code = 'EM' then 'EMC FACTORY'
                when M.factory_code = 'PN' then 'PIH ENC FACTORY'
                when M.factory_code = 'PR' then 'PIH RE FACTOR'
                when M.factory_code = 'SP' then 'SPEAKER'
                when M.factory_code = 'TN' then 'HFC FACTORY'
                when M.factory_code = 'HO' then 'HEAD OFFICE'
                when M.factory_code = 'PC' then 'PCB FACTORY'
            end factory_name
        FROM spare_part_request_master M
        left join users U on M.created_by = U.username
        left join subsection S on M.subsection_id = S.id
        where 1 = 1
        and M.is_active = 1
        order by id desc
    </select>


    <resultMap id="getSparePartRequestDetail-result"
               type="pidvn.modules.spare_part.models.SparePartRequestVo">
        <result column="request_no" property="requestNo" javaType="String"/>
        <result column="section_name" property="sectionName" javaType="String"/>
        <result column="part_number" property="partNumber" javaType="String"/>
    </resultMap>
    <select id="getSparePartRequestDetail" resultMap="getSparePartRequestDetail-result">
        select M.request_no, M.`date`, S.name section_name, D.part_number, D.qty from spare_part_request_master M
        inner join spare_part_request_detail D on M.id = D.request_id
        inner join section S on M.section_id = S.id
        where M.id = #{requestId}
    </select>



    <resultMap id="getSparePartRequestDetailByRequestId-result"
               type="pidvn.modules.spare_part.models.SparePartRequestVo">
        <result column="part_number" property="partNumber" javaType="String"/>
        <result column="part_name" property="partName" javaType="String"/>
        <result column="request_qty" property="requestQty" javaType="Float"/>
        <result column="kitting_qty" property="kittingQty" javaType="Float"/>
    </resultMap>
    <select id="getSparePartRequestDetailByRequestId" resultMap="getSparePartRequestDetailByRequestId-result">
        with
        T01 as (
            SELECT D.*, M.request_no, S.name part_name FROM spare_part_request_detail D
            inner join spare_part_request_master M on (D.request_id = M.id and D.request_id = #{requestId})
            left join spare_parts S on  (S.part_number = D.part_number and S.type = 'M4')
        )
        select T01.id, T01.part_number, T01.part_name, T01.qty request_qty, R.qty kitting_qty from T01
        left join spare_part_records R on (T01.request_no = R.request_no and T01.part_number = R.part_number)
    </select>
</mapper>